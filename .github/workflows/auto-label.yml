name: Auto Label

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issues:
    types: [opened, edited]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  label-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

  label-issue:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v8
        with:
          script: |
            const title = (context.payload.issue.title || '').toLowerCase();
            const body = (context.payload.issue.body || '').toLowerCase();
            const text = `${title} ${body}`;
            const labels = [];

            const patterns = {
              bug: ['crash', 'error', 'bug', 'broken', 'regression', 'fix', 'fails', 'not working'],
              security: ['security', 'vulnerability', 'cve', 'injection', 'xss'],
              performance: ['performance', 'slow', 'memory leak', 'latency', 'fps'],
              'game-engine': ['engine', 'combat', 'summon', 'phase', 'game state', 'card effect'],
              'story-mode': ['story', 'chapter', 'stage', 'campaign', 'dialogue'],
              pvp: ['pvp', 'lobby', 'matchmaking', 'multiplayer', 'duel'],
              ui: ['ui', 'frontend', 'component', 'layout', 'animation', 'css', 'style'],
              'ai-agent': ['agent', 'eliza', 'bot', 'ai player'],
            };

            for (const [label, keywords] of Object.entries(patterns)) {
              if (keywords.some(kw => text.includes(kw))) {
                labels.push(label);
              }
            }

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                labels,
              });
            }
